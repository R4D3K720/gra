<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#0b0d12">
<title>Neo Raid 3D</title>
<style>
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:#0b0d12;color:#fff;font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;overscroll-behavior:none}
  #app{position:fixed;inset:0}
  canvas{display:block;width:100vw;height:100vh}
  .hud{position:fixed;top:calc(env(safe-area-inset-top) + 10px);left:calc(env(safe-area-inset-left)+10px);right:calc(env(safe-area-inset-right)+10px);display:flex;gap:8px;align-items:center;justify-content:space-between;z-index:7;pointer-events:none}
  .pill{pointer-events:auto;display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);font-weight:700;letter-spacing:.3px;text-shadow:0 2px 8px rgba(0,0,0,.45)}
  .hearts{display:flex;gap:6px}
  .heart{width:18px;height:18px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#ff7aa2,#e11d48)}
  .controls{position:fixed;inset:0;pointer-events:none;z-index:9}
  .stickArea{position:absolute;bottom:calc(env(safe-area-inset-bottom)+18px);left:calc(env(safe-area-inset-left)+18px);width:168px;height:168px;border-radius:20px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);pointer-events:auto;touch-action:none}
  .stick{position:absolute;left:50%;top:50%;width:76px;height:76px;transform:translate(-50%,-50%);border-radius:999px;background:rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.4);box-shadow:0 10px 24px rgba(0,0,0,.35)}
  .btn{position:absolute;right:calc(env(safe-area-inset-right)+18px);bottom:calc(env(safe-area-inset-bottom)+18px);width:120px;height:120px;border-radius:24px;border:none;pointer-events:auto;touch-action:manipulation;font-weight:900;letter-spacing:.5px}
  .btnAttack{background:linear-gradient(90deg,#fda4af,#f472b6,#a78bfa);color:#0b0d12;box-shadow:0 16px 40px rgba(250,100,160,.35)}
  .btnDash{right:calc(env(safe-area-inset-right)+150px);width:104px;height:104px;border-radius:20px;background:linear-gradient(90deg,#67e8f9,#60a5fa);color:#0b0d12;box-shadow:0 16px 40px rgba(100,180,250,.35)}
  .btn:active{transform:scale(.98)}
  .overlay{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 800px at 50% 10%,rgba(255,255,255,.07),transparent 60%);backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);z-index:10}
  .card{width:min(92vw,580px);background:rgba(23,26,38,.9);border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:20px;text-align:center;box-shadow:0 24px 64px rgba(0,0,0,.5)}
  .big{margin-top:12px;width:100%;padding:14px 16px;border-radius:12px;border:none;font-weight:800;letter-spacing:.6px;text-transform:uppercase;background:linear-gradient(90deg,#67e8f9,#a78bfa,#f472b6);color:#0b0d12;box-shadow:0 10px 30px rgba(164,120,250,.25)}
  .ghost{margin-top:10px;background:transparent;color:#fff;border:1px solid rgba(255,255,255,.25);box-shadow:none}
  .hidden{display:none}
  .shop{position:fixed;right:calc(env(safe-area-inset-right)+10px);top:calc(env(safe-area-inset-top)+70px);z-index:8;pointer-events:auto}
  .shop .item{margin:8px 0;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);display:flex;justify-content:space-between;gap:10px;min-width:240px}
  .shop .buy{font-weight:800;border:none;border-radius:10px;padding:8px 12px;background:linear-gradient(90deg,#67e8f9,#a78bfa);color:#0b0d12}
  .tip{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom)+10px);transform:translateX(-50%);padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:7;opacity:0;transition:opacity .25s, transform .25s}
  .tip.show{opacity:1;transform:translate(-50%,-4px)}
</style>
</head>
<body>
<div id="app"></div>

<div class="hud">
  <div class="pill">üíé Monety: <span id="coins">0</span></div>
  <div class="pill" id="toggleShop" style="cursor:pointer">üõí Sklep</div>
  <div class="pill hearts" id="hearts"></div>
</div>

<div class="shop hidden" id="shop">
  <div class="item"><div>üó°Ô∏è Miecz+ (DMG)</div><button class="buy" data-key="sword" data-cost="150">Kup 150</button></div>
  <div class="item"><div>‚ù§Ô∏è Serce+ (HP)</div><button class="buy" data-key="heart" data-cost="120">Kup 120</button></div>
  <div class="item"><div>‚ö° Dash+ (czas/CD)</div><button class="buy" data-key="dash" data-cost="130">Kup 130</button></div>
  <div class="item"><div>üëü Szybko≈õƒá+ (ruch)</div><button class="buy" data-key="speed" data-cost="100">Kup 100</button></div>
</div>

<div class="controls">
  <div class="stickArea" id="stickArea"><div class="stick" id="stick"></div></div>
  <button class="btn btnAttack" id="btnAttack">ATAK</button>
  <button class="btn btnDash" id="btnDash">DASH</button>
</div>

<div class="overlay" id="startOv">
  <div class="card">
    <h1>‚öîÔ∏è Neo Raid 3D</h1>
    <p>Lewy kciuk ‚Äì joystick. Prawy: <b>ATAK</b> mieczem lub <b>DASH</b> przez wrog√≥w.<br>Pokonuj fale, zbieraj monety, kupuj ulepszenia.</p>
    <button class="big" id="playBtn">‚ñ∂Ô∏è Zaczynamy</button>
    <button class="big ghost" id="addBtn">‚ûï Dodaj do ekranu poczƒÖtkowego</button>
  </div>
</div>

<div class="overlay hidden" id="gameOver">
  <div class="card">
    <h1>üí• Koniec gry</h1>
    <p>Wynik (monety): <b id="finalScore">0</b></p>
    <button class="big" id="againBtn">üîÅ Jeszcze raz</button>
  </div>
</div>

<div class="tip" id="tip">Zbieraj monety i ulepszaj w sklepie</div>

<script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
<script>
(() => {
  // ---------- podstawy ----------
  const app = document.getElementById('app');
  const renderer = new THREE.WebGLRenderer({ antialias:true, powerPreference:'high-performance' });
  renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  app.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b0d12);
  scene.fog = new THREE.FogExp2(0x0b0d12, 0.035);

  const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 220);
  camera.position.set(0, 7.5, 12);

  const hemi = new THREE.HemisphereLight(0xa3baff, 0x1b1f2a, 0.9); scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 1.2);
  dir.position.set(6, 10, 4); dir.castShadow = true;
  dir.shadow.mapSize.set(2048,2048); dir.shadow.camera.near = 1; dir.shadow.camera.far = 60;
  scene.add(dir);

  // ---------- arena ----------
  const arena = new THREE.Group(); scene.add(arena);
  const floor = new THREE.Mesh(new THREE.CircleGeometry(9,64), new THREE.MeshStandardMaterial({color:0x18212f,roughness:.85,metalness:.05}));
  floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; arena.add(floor);
  const rim = new THREE.Mesh(new THREE.CylinderGeometry(9,8.8,2.4,64,1,true),
    new THREE.MeshStandardMaterial({color:0x0e1522,roughness:.9,metalness:.05,side:THREE.DoubleSide}));
  rim.position.y = -1.2; rim.castShadow = rim.receiveShadow = true; arena.add(rim);

  // ---------- gracz (humanoid) ----------
  const player = new THREE.Group(); arena.add(player);
  const body = new THREE.Mesh(new THREE.CapsuleGeometry(.55,1.1,8,16),
    new THREE.MeshStandardMaterial({color:0x8ab4ff,roughness:.35,metalness:.5,emissive:0x6aa2ff,emissiveIntensity:.15}));
  body.castShadow = true; body.position.y = 1.25; player.add(body);
  const head = new THREE.Mesh(new THREE.SphereGeometry(.5,24,24),
    new THREE.MeshStandardMaterial({color:0xcde3ff,roughness:.25,metalness:.6,emissive:0x9bd8ff,emissiveIntensity:.15}));
  head.castShadow = true; head.position.y = 2.2; player.add(head);
  const eyeGeo = new THREE.PlaneGeometry(.12,.12), eyeMat = new THREE.MeshBasicMaterial({color:0x0a0c12,side:THREE.DoubleSide});
  const eyeL = new THREE.Mesh(eyeGeo, eyeMat), eyeR = new THREE.Mesh(eyeGeo, eyeMat);
  eyeL.position.set(-.16,.05,.48); eyeR.position.set(.16,.05,.48); head.add(eyeL); head.add(eyeR);
  function arm(){return new THREE.Mesh(new THREE.CapsuleGeometry(.18,.6,8,16), new THREE.MeshStandardMaterial({color:0x8ab4ff,roughness:.4,metalness:.4}))}
  const armL = arm(); armL.position.set(-.7,1.5,0); armL.castShadow = true; player.add(armL);
  const armR = arm(); armR.position.set(.7,1.5,0); armR.castShadow = true; player.add(armR);
  const sword = new THREE.Mesh(new THREE.BoxGeometry(.12,1.2,.12),
    new THREE.MeshStandardMaterial({color:0xa78bfa,metalness:.9,roughness:.1,emissive:0x9f88ff,emissiveIntensity:.3}));
  sword.castShadow = true; sword.position.set(0,-.5,0); armR.add(sword);
  player.add(new THREE.Mesh(new THREE.CylinderGeometry(.25,.25,.12,16), new THREE.MeshStandardMaterial({color:0x90b6ff,roughness:.6,metalness:.2}))).position.set(-.35,.12,.25);
  player.add(new THREE.Mesh(new THREE.CylinderGeometry(.25,.25,.12,16), new THREE.MeshStandardMaterial({color:0x90b6ff,roughness:.6,metalness:.2}))).position.set(.35,.12,.25);
  player.position.set(0,0,4);

  // ---------- wrogowie ----------
  const enemies = [];
  function spawnEnemy(){
    const e = new THREE.Mesh(new THREE.CapsuleGeometry(.45,.6,8,16),
      new THREE.MeshStandardMaterial({color:0xf472b6,roughness:.35,metalness:.3,emissive:0xff7acb,emissiveIntensity:.25}));
    e.castShadow = true;
    const a = Math.random()*Math.PI*2, r = 7.6;
    e.position.set(Math.cos(a)*r, .6, Math.sin(a)*r);
    e.userData = { speed: 1.2 + Math.random()*0.7, hp: 2, alive: true, knock:0, kx:0, kz:0 };
    arena.add(e); enemies.push(e);
  }

  // ---------- dropy ----------
  const drops = [];
  function dropCoin(x,y,z){
    const d = new THREE.Mesh(new THREE.CylinderGeometry(.16,.16,.06,16),
      new THREE.MeshStandardMaterial({color:0xffd166, metalness:.9, roughness:.2, emissive:0xffc94a, emissiveIntensity:.3}));
    d.rotation.x = Math.PI/2; d.castShadow = true; d.position.set(x,y,z);
    d.userData = { vy: 2.2, t: 0 }; arena.add(d); drops.push(d);
  }

  // ---------- stan gry ----------
  const state = {
    coins: Number(localStorage.getItem('nr3d_coins') || 0),
    hearts: Number(localStorage.getItem('nr3d_hearts') || 3),
    maxHearts: Number(localStorage.getItem('nr3d_maxhearts') || 3),
    swordLvl: Number(localStorage.getItem('nr3d_sword') || 1),
    dashLvl: Number(localStorage.getItem('nr3d_dash') || 1),
    speedLvl: Number(localStorage.getItem('nr3d_speed') || 1),
    running:false, invuln:0, dash:false, dashTime:0, dashCD:0, wave:1, waveTimer:3
  };

  // ---------- HUD / sklep ----------
  const coinsEl = document.getElementById('coins');
  const heartsEl = document.getElementById('hearts');
  const tipEl = document.getElementById('tip');
  const shop = document.getElementById('shop');
  document.getElementById('toggleShop').onclick = ()=> shop.classList.toggle('hidden');
  shop.addEventListener('click', e=>{
    const btn = e.target.closest('.buy'); if(!btn) return;
    const cost = +btn.dataset.cost, key = btn.dataset.key;
    if (state.coins < cost) return showTip('Za ma≈Ço monet');
    state.coins -= cost;
    if (key==='sword') state.swordLvl++;
    if (key==='heart'){ state.maxHearts++; state.hearts = state.maxHearts; }
    if (key==='dash') state.dashLvl++;
    if (key==='speed') state.speedLvl++;
    updateHUD(); saveState(); showTip('Kupiono ‚úì');
  });

  function updateHUD(){
    coinsEl.textContent = state.coins|0;
    heartsEl.innerHTML = '';
    for (let i=0;i<state.hearts;i++){ const h=document.createElement('div'); h.className='heart'; heartsEl.appendChild(h); }
  }
  function saveState(){
    localStorage.setItem('nr3d_coins', state.coins|0);
    localStorage.setItem('nr3d_hearts', state.hearts|0);
    localStorage.setItem('nr3d_maxhearts', state.maxHearts|0);
    localStorage.setItem('nr3d_sword', state.swordLvl|0);
    localStorage.setItem('nr3d_dash', state.dashLvl|0);
    localStorage.setItem('nr3d_speed', state.speedLvl|0);
  }
  updateHUD();

  // ---------- joystick + akcje ----------
  const stickArea = document.getElementById('stickArea');
  const stick = document.getElementById('stick');
  const btnAttack = document.getElementById('btnAttack');
  const btnDash   = document.getElementById('btnDash');
  let joy = { active:false, dx:0, dz:0, base:{x:0,y:0} };
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  function onStickStart(e){ joy.active = true; const t=e.touches?e.touches[0]:e; joy.base.x=t.clientX; joy.base.y=t.clientY; moveStick(t.clientX,t.clientY); e.preventDefault();}
  function onStickMove(e){ if(!joy.active) return; const t=e.touches?e.touches[0]:e; moveStick(t.clientX,t.clientY); e.preventDefault();}
  function onStickEnd(){ joy.active=false; joy.dx=0; joy.dz=0; stick.style.left='50%'; stick.style.top='50%'; }
  function moveStick(cx,cy){ const dx=clamp((cx-joy.base.x)/60,-1,1), dy=clamp((cy-joy.base.y)/60,-1,1); joy.dx=dx; joy.dz=dy; stick.style.left=`calc(50% + ${clamp(dx*60,-40,40)}px)`; stick.style.top=`calc(50% + ${clamp(dy*60,-40,40)}px)`; }
  stickArea.addEventListener('pointerdown', onStickStart, {passive:false});
  stickArea.addEventListener('pointermove', onStickMove, {passive:false});
  addEventListener('pointerup', onStickEnd, {passive:true});
  stickArea.addEventListener('touchstart', e=>e.preventDefault(), {passive:false});
  stickArea.addEventListener('touchmove', e=>e.preventDefault(), {passive:false});

  let attackWind = 0;
  btnAttack.addEventListener('click', ()=> doAttack(), {passive:true});
  btnDash.addEventListener('click', ()=> doDash(), {passive:true});
  addEventListener('keydown', e=>{ if(e.code==='Space') doAttack(); if(e.code==='ShiftLeft') doDash(); });

  function doAttack(){ if(!state.running || attackWind>0) return; attackWind=0.22; swingSword(); }
  function doDash(){ if(!state.running || state.dashCD>0 || state.dash) return; state.dash=true; state.dashTime=0.28+(state.dashLvl-1)*0.06; state.dashCD=Math.max(0.5,1.2-(state.dashLvl-1)*0.15); burst(player.position.x,.6,player.position.z,14,0x9bd8ff); }

  // ---------- czƒÖsteczki ----------
  const particles=[]; const pGeo=new THREE.PlaneGeometry(.06,.06);
  function burst(x,y,z,count,color){
    for(let i=0;i<count;i++){
      const m=new THREE.Mesh(pGeo,new THREE.MeshBasicMaterial({color,transparent:true,opacity:1,side:THREE.DoubleSide}));
      m.position.set(x,y,z); m.rotation.y=Math.random()*Math.PI;
      m.userData={vx:(Math.random()-.5)*2.4,vy:Math.random()*2.6,vz:(Math.random()-.5)*2.4,life:.7,t:0};
      scene.add(m); particles.push(m);
    }
  }

  // ---------- kamera ----------
  const camTarget = new THREE.Vector3();
  function updateCamera(dt){
    const k = 1 - Math.pow(0.001, dt*60);
    const desired = new THREE.Vector3(player.position.x, 3.6, player.position.z+7.8);
    camera.position.lerp(desired, k);
    camTarget.set(player.position.x, player.position.y+1.1, player.position.z);
    camera.lookAt(camTarget);
  }

  // ---------- anim miecza ----------
  function swingSword(){
    const t0 = performance.now();
    (function anim(){
      const t = (performance.now()-t0)/220;
      if (t>=1){ armR.rotation.set(0,0,0); sword.rotation.set(0,0,0); return; }
      armR.rotation.z = -Math.sin(t*Math.PI)*1.1;
      armR.rotation.y =  Math.sin(t*Math.PI)*0.3;
      sword.rotation.x = Math.sin(t*Math.PI)*0.6;
      requestAnimationFrame(anim);
    })();
  }

  // ---------- pƒôtla ----------
  const startOv = document.getElementById('startOv');
  const gameOver = document.getElementById('gameOver');
  const playBtn = document.getElementById('playBtn');
  const againBtn = document.getElementById('againBtn');
  const finalScore = document.getElementById('finalScore');
  const addBtn = document.getElementById('addBtn');
  let deferredPrompt=null;
  addEventListener('beforeinstallprompt', e=>{ e.preventDefault(); deferredPrompt=e; });
  addBtn.addEventListener('click', async ()=>{ if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; } else alert('Na iPhonie: Udostƒôpnij ‚Üí Dodaj do ekranu'); });

  function begin(){ state.running=true; state.hearts = Math.max(1,state.maxHearts); updateHUD(); showTip('Pokonuj fale i zbieraj monety'); startOv.classList.add('hidden'); gameOver.classList.add('hidden'); }
  function end(){ state.running=false; finalScore.textContent = state.coins|0; gameOver.classList.remove('hidden'); }
  playBtn.onclick = begin; againBtn.onclick = begin;

  function showTip(msg){ tipEl.textContent=msg; tipEl.classList.add('show'); setTimeout(()=>tipEl.classList.remove('show'),1400); }

  function spawnWave(n){ for(let i=0;i<n;i++) spawnEnemy(); }

  let last = performance.now();
  function loop(now){
    const dt = Math.min(.033, (now-last)/1000); last = now;

    if (state.running){
      // ruch
      const base = 3.2*(1+0.15*(state.speedLvl-1));
      const speed = state.dash ? base*3.4 : base;
      const vx = joy.dx*speed, vz = -joy.dz*speed;
      player.position.x += vx*dt; player.position.z += vz*dt;
      const rad = Math.hypot(player.position.x, player.position.z);
      if (rad>8.2){ const k=8.2/rad; player.position.x*=k; player.position.z*=k; }
      body.position.y = 1.25 + ((Math.abs(vx)+Math.abs(vz)>0.01)? Math.sin(now*0.02)*0.05:0);
      head.position.y = 2.2  + ((Math.abs(vx)+Math.abs(vz)>0.01)? Math.sin(now*0.02+0.6)*0.03:0);

      // atak mieczem ‚Äì okno trafie≈Ñ
      if (attackWind>0){
        attackWind -= dt;
        for (let i=enemies.length-1;i>=0;i--){
          const e=enemies[i]; if(!e.userData.alive) continue;
          const dx=e.position.x-player.position.x, dz=e.position.z-player.position.z, dist=Math.hypot(dx,dz);
          if (dist<1.6){
            e.userData.hp -= (1 + 0.5*(state.swordLvl-1));
            e.userData.knock = 0.22; const ang=Math.atan2(dz,dx); e.userData.kx=Math.cos(ang); e.userData.kz=Math.sin(ang);
            burst(e.position.x,.7,e.position.z,8,0xf472b6);
            if (e.userData.hp<=0){ e.userData.alive=false; dropCoin(e.position.x,.2,e.position.z); arena.remove(e); e.geometry.dispose(); e.material.dispose(); enemies.splice(i,1); }
          }
        }
      }

      // fale wrog√≥w
      state.waveTimer -= dt;
      if (state.waveTimer<=0){ spawnWave(1 + Math.floor(state.wave*0.6)); state.wave++; state.waveTimer = 4 - Math.min(2.5, state.wave*0.1); }
      for (let i=enemies.length-1;i>=0;i--){
        const e=enemies[i]; if(!e.userData.alive) continue;
        if (e.userData.knock>0){ e.userData.knock-=dt; e.position.x += e.userData.kx*6*dt; e.position.z += e.userData.kz*6*dt; continue; }
        const v = new THREE.Vector3().subVectors(player.position, e.position); v.y=0; const len=v.length()||0.001; v.normalize();
        e.position.addScaledVector(v, e.userData.speed*dt);
        e.rotation.y += dt*2;
        const dist = e.position.distanceTo(player.position);
        if (dist<0.8){
          if (state.dash){
            e.userData.alive=false; dropCoin(e.position.x,.2,e.position.z); arena.remove(e); e.geometry.dispose(); e.material.dispose(); enemies.splice(i,1);
          } else if (state.invuln<=0){
            state.hearts--; state.invuln=1.2; updateHUD(); if(state.hearts<=0){ saveState(); end(); }
          }
        }
      }

      // monety ‚Äì grawitacja i zbi√≥r
      for (let i=drops.length-1;i>=0;i--){
        const d=drops[i]; d.userData.t+=dt; d.position.y += d.userData.vy*dt; d.userData.vy -= 7*dt;
        if (d.position.y<0.06) d.position.y=0.06;
        if (d.position.distanceTo(player.position)<0.8){
          state.coins += 10; arena.remove(d); d.geometry.dispose(); d.material.dispose(); drops.splice(i,1); updateHUD(); saveState();
        }
      }

      // dash i nietykalno≈õƒá
      if (state.dash){ state.dashTime-=dt; if (state.dashTime<=0) state.dash=false; }
      if (state.dashCD>0) state.dashCD-=dt;
      if (state.invuln>0) state.invuln-=dt;

      // czƒÖsteczki
      for (let i=particles.length-1;i>=0;i--){
        const p=particles[i], u=p.userData; u.t+=dt; p.position.x+=u.vx*dt; p.position.y+=u.vy*dt; p.position.z+=u.vz*dt; u.vy-=3.5*dt;
        p.material.opacity = Math.max(0,1-u.t/u.life);
        if (u.t>=u.life){ scene.remove(p); p.geometry.dispose(); p.material.dispose(); particles.splice(i,1); }
      }

      updateCamera(dt);
    }

    renderer.render(scene, camera);
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ---------- start/koniec ----------
  const startOv = document.getElementById('startOv');
  const gameOver = document.getElementById('gameOver');
  const finalScore = document.getElementById('finalScore');
  document.getElementById('playBtn').onclick = begin;
  document.getElementById('againBtn').onclick = begin;
  function begin(){ state.running=true; updateHUD(); startOv.classList.add('hidden'); gameOver.classList.add('hidden'); showTip('Pokonuj fale i zbieraj monety'); }
  function end(){ state.running=false; finalScore.textContent=state.coins|0; gameOver.classList.remove('hidden'); }

  // ---------- resize ----------
  addEventListener('resize', ()=>{ renderer.setSize(innerWidth, innerHeight); camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); }, {passive:true});

  // ---------- tip ----------
  function showTip(msg){ tipEl.textContent=msg; tipEl.classList.add('show'); setTimeout(()=>tipEl.classList.remove('show'),1400); }
})();
</script>
</body>
</html>
